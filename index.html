<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regional Map Explorer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .search-container {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .search-box {
            display: flex;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #ddd;
            border-radius: 50px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
        }
        
        .search-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .main-content {
            display: flex;
            height: 600px;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .info-panel {
            width: 400px;
            background: white;
            border-left: 1px solid #e9ecef;
            overflow-y: auto;
        }
        
        .info-content {
            padding: 30px;
        }
        
        .info-title {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .info-text {
            color: #555;
            line-height: 1.8;
            margin-bottom: 20px;
        }
        
        .region-stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .stat-label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-value {
            color: #667eea;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        .error {
            color: #e74c3c;
            background: #fdf2f2;
            padding: 20px;
            border-radius: 10px;
            margin: 20px;
            border-left: 4px solid #e74c3c;
        }

        .search-suggestion {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #2196f3;
        }
        
        .suggestion-title {
            font-weight: bold;
            color: #1565c0;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Regional Map Explorer</h1>
            <p>Search for any address and discover which region it belongs to</p>
        </div>
        
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="addressInput" class="search-input" 
                       placeholder="Enter an address (e.g., 1125 B St, San Rafael)">
                <button id="searchBtn" class="search-btn">Search</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="map-container">
                <div id="map"></div>
            </div>
            
            <div class="info-panel">
                <div class="info-content" id="infoContent">
                    <div class="info-title">Welcome to </div>
                    <div class="info-text">
                        Enter any address in Marin into the search box above to discover which rancho used to exist there. 
                        The map shows the original ranchos of Marin with detailed information about them all.
                    </div>
                    <div class="info-text">
                        Click on any rancho or search for an address to get detailed information!
                    </div>
                    <div class="info-text">
                        This system uses free OpenStreetMap data integrated using Leaflet.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        let map;
        let regions = [];
        let currentMarker;
        let historicalOverlay;

        // Sample region data with polygons centered around NYC
        const regionData = {
            'Corte Madera de Novato': {
                coordinates: [
                    [38.168250396984384, -122.69407654122918],
                    [38.13396247671964, -122.72497558908073],
                    [38.12045887373562, -122.7016296418151],
                    [38.112355513009696, -122.7016296418151],
                    [38.11208538550022, -122.69407654122918],
                    [38.111274996977635, -122.68824005441276],
                    [38.1066826255182, -122.6848068268737],
                    [38.10560202557017, -122.67759704904168],
                    [38.102630293298475, -122.67382049874871],
                    [38.102630293298475, -122.65871429757682],
                    [38.10587217705566, -122.65356445626824],
                    [38.104791565119946, -122.63227844552605],
                    [38.10803335297616, -122.63227844552605],
                    [38.110464599463874, -122.62712860421745],
                    [38.120999065813564, -122.62678528146354],
                    [38.12153925389513, -122.63021850900262],
                    [38.136122821387204, -122.63021850900262],
                    [38.139093190885205, -122.63605499581902],
                    [38.14557357737077, -122.63365173654168],
                    [38.15016350287313, -122.64189148263542],
                    [38.14692358543955, -122.65459442452996],
                    [38.15124344337197, -122.66626739816276],
                    [38.1496235266276, -122.67450714425652],
                    [38.168250396984384, -122.69407654122918]
                ],
                color: '#e74c3c',
                info: {
                    title: 'Corte Madera de Novato',
                    description: 'Historic rancho boundary',
                    details: 'One of the historic Mexican land grants in Marin County',
                    features: 'Original rancho boundaries from historical records',
                }
            },
            'Soullajule': {
                coordinates: [
                    [-122.72525024571226, 38.134070493823586],
                    [-122.76044082798765, 38.12340287045033],
                    [-122.78790664830015, 38.14554657530658],
                    [-122.82103729405208, 38.15769575300814],
                    [-122.83992004551695, 38.16889820084662],
                    [-122.86127472238152, 38.18109746185443],
                    [-122.87226105050651, 38.19480570412978],
                    [-122.86505127267449, 38.20883508601526],
                    [-122.85234833077995, 38.20910485532582],
                    [-122.84410858468621, 38.20505821068454],
                    [-122.83449554757682, 38.20020194017038],
                    [-122.8279724152526, 38.20397906745351],
                    [-122.81423950509635, 38.20397906745351],
                    [-122.80840301827995, 38.20236032261288],
                    [-122.80290985421746, 38.19750387213767],
                    [-122.80016327218621, 38.18563118511921],
                    [-122.78608703927604, 38.1807736189769],
                    [-122.77819061593621, 38.17888447801048],
                    [-122.77132416085807, 38.17456625759166],
                    [-122.76205444650262,38.15702085590265],
                    [-122.73527527169793, 38.164579392822404],
                    [-122.6951065094909, 38.16862828670254],
                    [-122.72525024571226, 38.134070493823586]
                ],
                color: '#65e73c',
                info: {
                    title: 'Soullajule',
                    description: 'Historic rancho boundary',
                    details: 'One of the historic Mexican land grants in Marin County',
                    features: 'Original rancho boundaries from historical records',
                }
            },
            'Laguna de San Antonio': {
                coordinates: [
                    [-122.80325317697137, 38.266165545687045],
                    [-122.81835937814323, 38.2607742017911],
                    [-122.76171112374871, 38.157992709215904],
                    [-122.6734771759948, 38.18444380750062],
                    [-122.67553711251824, 38.186062950631374],
                    [-122.67279053048699, 38.191729668183555],
                    [-122.6786270173034, 38.190650327400974],
                    [-122.68103027658073, 38.194158126461524],
                    [-122.68652344064323, 38.197395944866685],
                    [-122.6902999909362, 38.19766575656877],
                    [-122.69750976876824, 38.197395944866685],
                    [-122.69956970529168, 38.20063361930768],
                    [-122.70300293283073, 38.20063361930768],
                    [-122.70574951486198, 38.19793556727113],
                    [-122.71124267892448, 38.20360136107342],
                    [-122.71295929269402, 38.20845740483092],
                    [-122.71536255197137, 38.20953648167321],
                    [-122.71398926095574, 38.2157408630576],
                    [-122.80325317697137, 38.266165545687045]
                ],
                color: '#853ce7',
                info: {
                    title: 'Laguna de San Antonio',
                    description: 'Historic rancho boundary',
                    details: 'One of the historic Mexican land grants in Marin County',
                    features: 'Original rancho boundaries from historical records',
                }
            }
        };

        function initMap() {
            // Initialize map centered on NYC
            map = L.map('map').setView([38.0834, -122.7633], 10);

            // Add OpenStreetMap tile layer (completely free)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            const historicalBounds = [
                [37.806984, -123.051164], // Southwest corner
                [38.266598, -122.251757]  // Northeast corner
            ];
            
            // Replace this URL with your historical map image
            historicalOverlay = L.imageOverlay(
                '/6223743031_813d5420e3_b-1418050841 (1).webp',
                historicalBounds,
                {
                    opacity: 0.7,
                    interactive: false
                }
            );

            // Create region polygons
            Object.keys(regionData).forEach(regionName => {
                const region = regionData[regionName];
                const polygon = L.polygon(region.coordinates, {
                    color: region.color,
                    weight: 3,
                    opacity: 0.8,
                    fillColor: region.color,
                    fillOpacity: 0.2
                }).addTo(map);

                regions.push({
                    name: regionName,
                    polygon: polygon,
                    data: region
                });

                // Add click listener to polygon
                polygon.on('click', () => {
                    showRegionInfo(regionName, region.info);
                });

                // Add popup on hover
                polygon.bindTooltip(regionName, {
                    permanent: false,
                    direction: 'center'
                });
            });

            // Search functionality
            document.getElementById('searchBtn').addEventListener('click', searchAddress);
            document.getElementById('addressInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchAddress();
                }
            });
        }

        async function searchAddress() {
            const address = document.getElementById('addressInput').value;
            if (!address) {
                alert('Please enter an address');
                return;
            }

            showLoading();

            try {
                // Use Nominatim (OpenStreetMap's free geocoding service)
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    const displayName = data[0].display_name;

                    // Clear previous marker
                    if (currentMarker) {
                        map.removeLayer(currentMarker);
                    }

                    // Add marker
                    currentMarker = L.marker([lat, lng])
                        .addTo(map)
                        .bindPopup(displayName)
                        .openPopup();

                    // Center map on result
                    map.setView([lat, lng], 15);

                    // Check which region contains this point
                    const foundRegion = findRegionContainingPoint(lat, lng);
                    
                    if (foundRegion) {
                        showRegionInfo(foundRegion.name, foundRegion.data.info, displayName);
                        // Highlight the found region
                        foundRegion.polygon.setStyle({
                            weight: 5,
                            opacity: 1,
                            fillOpacity: 0.4
                        });
                        setTimeout(() => {
                            foundRegion.polygon.setStyle({
                                weight: 3,
                                opacity: 0.8,
                                fillOpacity: 0.2
                            });
                        }, 3000);
                    } else {
                        showNoRegionFound(displayName);
                    }
                } else {
                    showError('Address not found. Please try a different search term.');
                }
            } catch (error) {
                showError('Search failed. Please check your internet connection and try again.');
                console.error('Geocoding error:', error);
            }
        }

        function findRegionContainingPoint(lat, lng) {
            for (let region of regions) {
                if (isPointInPolygon(lat, lng, region.data.coordinates)) {
                    return region;
                }
            }
            return null;
        }

        function isPointInPolygon(lat, lng, coordinates) {
            let inside = false;
            for (let i = 0, j = coordinates.length - 1; i < coordinates.length; j = i++) {
                const xi = coordinates[i][0];
                const yi = coordinates[i][1];
                const xj = coordinates[j][0];
                const yj = coordinates[j][1];

                if (((yi > lng) !== (yj > lng)) && (lat < (xj - xi) * (lng - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            return inside;
        }

        function showRegionInfo(regionName, info, searchAddress = null) {
            const infoContent = document.getElementById('infoContent');
            
            infoContent.innerHTML = `
                <div class="info-title">${info.title}</div>
                ${searchAddress ? `<div class="info-text"><strong>Searched Address:</strong> ${searchAddress}</div>` : ''}
                <div class="info-text">${info.description}</div>
                <div class="info-text">${info.details}</div>
                <div class="region-stats">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">Region Statistics</h3>
                    ${Object.keys(info.stats).map(stat => `
                        <div class="stat-item">
                            <span class="stat-label">${stat}:</span>
                            <span class="stat-value">${info.stats[stat]}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="info-text">${info.features}</div>
            `;
        }

        function showLoading() {
            const infoContent = document.getElementById('infoContent');
            infoContent.innerHTML = '<div class="loading">Searching for address</div>';
        }

        function showError(message) {
            const infoContent = document.getElementById('infoContent');
            infoContent.innerHTML = `<div class="error">${message}</div>`;
        }

        function showNoRegionFound(address) {
            const infoContent = document.getElementById('infoContent');
            infoContent.innerHTML = `
                <div class="info-title">Location Found</div>
                <div class="info-text"><strong>Address:</strong> ${address}</div>
                <div class="info-text">This location is outside of our defined regions. The marker shows the exact location on the map.</div>
                <div class="info-text">Try searching for addresses within the colored regions to get detailed regional information, or click directly on any colored region.</div>
            `;
        }

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
