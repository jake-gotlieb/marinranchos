<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regional Map Explorer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .search-container {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .search-box {
            display: flex;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #ddd;
            border-radius: 50px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
        }
        
        .search-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .main-content {
            display: flex;
            height: 600px;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .info-panel {
            width: 400px;
            background: white;
            border-left: 1px solid #e9ecef;
            overflow-y: auto;
        }
        
        .info-content {
            padding: 30px;
        }
        
        .info-title {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .info-text {
            color: #555;
            line-height: 1.8;
            margin-bottom: 20px;
        }
        
        .region-stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .stat-label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-value {
            color: #667eea;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        .error {
            color: #e74c3c;
            background: #fdf2f2;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #e74c3c;
        }

        .search-suggestion {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #2196f3;
        }
        
        .suggestion-title {
            font-weight: bold;
            color: #1565c0;
            margin-bottom: 5px;
        }

        .coordinates-info {
            background: #f0f8f0;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #4caf50;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Regional Map Explorer</h1>
            <p>Search for any address and discover which region it belongs to</p>
        </div>
        
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="addressInput" class="search-input" 
                       placeholder="Enter an address (e.g., 1125 B St, San Rafael)">
                <button id="searchBtn" class="search-btn">Search</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="map-container">
                <div id="map"></div>
            </div>
            
            <div class="info-panel">
                <div class="info-content" id="infoContent">
                    <div class="info-title">Welcome to Regional Explorer</div>
                    <div class="info-text">
                        Enter any address in Marin County into the search box above to discover which historic rancho it belongs to.
                    </div>
                    <div class="info-text">
                        The map shows the original ranchos of Marin County with detailed information about each one.
                    </div>
                    <div class="info-text">
                        Click on any rancho polygon or search for an address to get detailed information!
                    </div>
                    <div class="info-text">
                        This system uses free OpenStreetMap data integrated using Leaflet.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        let map;
        let regions = [];
        let currentMarker;
        let highlightedRegion = null;

        // Enhanced region data with proper statistics and information
        const regionData = {
            'Corte Madera de Novato': {
                coordinates: [
                    [38.168250396984384, -122.69407654122918],
                    [38.13396247671964, -122.72497558908073],
                    [38.12045887373562, -122.7016296418151],
                    [38.112355513009696, -122.7016296418151],
                    [38.11208538550022, -122.69407654122918],
                    [38.111274996977635, -122.68824005441276],
                    [38.1066826255182, -122.6848068268737],
                    [38.10560202557017, -122.67759704904168],
                    [38.102630293298475, -122.67382049874871],
                    [38.102630293298475, -122.65871429757682],
                    [38.10587217705566, -122.65356445626824],
                    [38.104791565119946, -122.63227844552605],
                    [38.10803335297616, -122.63227844552605],
                    [38.110464599463874, -122.62712860421745],
                    [38.120999065813564, -122.62678528146354],
                    [38.12153925389513, -122.63021850900262],
                    [38.136122821387204, -122.63021850900262],
                    [38.139093190885205, -122.63605499581902],
                    [38.14557357737077, -122.63365173654168],
                    [38.15016350287313, -122.64189148263542],
                    [38.14692358543955, -122.65459442452996],
                    [38.15124344337197, -122.66626739816276],
                    [38.1496235266276, -122.67450714425652],
                    [38.168250396984384, -122.69407654122918]
                ],
                color: '#e74c3c',
                info: {
                    title: 'Corte Madera de Novato',
                    description: 'Historic Mexican land grant covering the northern portion of present-day Marin County.',
                    details: 'This rancho was granted to Fernando Félix in 1839 and encompassed approximately 48,000 acres. The name means "place where wood is cut" in Spanish, referring to the lumber operations in the area.',
                    features: 'Includes the modern cities of Novato and parts of Petaluma. Known for its oak woodlands and agricultural heritage.',
                    stats: {
                        'Grant Year': '1839',
                        'Original Grantee': 'Fernando Félix',
                        'Approximate Acres': '48,000',
                        'Modern Cities': 'Novato, Petaluma (parts)'
                    }
                }
            },
            'Soullajule': {
                coordinates: [
                    [38.134070493823586, -122.72525024571226],
                    [38.12340287045033, -122.76044082798765],
                    [38.14554657530658, -122.78790664830015],
                    [38.15769575300814, -122.82103729405208],
                    [38.16889820084662, -122.83992004551695],
                    [38.18109746185443, -122.86127472238152],
                    [38.19480570412978, -122.87226105050651],
                    [38.20883508601526, -122.86505127267449],
                    [38.20910485532582, -122.85234833077995],
                    [38.20505821068454, -122.84410858468621],
                    [38.20020194017038, -122.83449554757682],
                    [38.20397906745351, -122.8279724152526],
                    [38.20397906745351, -122.81423950509635],
                    [38.20236032261288, -122.80840301827995],
                    [38.19750387213767, -122.80290985421746],
                    [38.18563118511921, -122.80016327218621],
                    [38.1807736189769, -122.78608703927604],
                    [38.17888447801048, -122.77819061593621],
                    [38.17456625759166, -122.77132416085807],
                    [38.15702085590265, -122.76205444650262],
                    [38.164579392822404, -122.73527527169793],
                    [38.16862828670254, -122.6951065094909],
                    [38.134070493823586, -122.72525024571226]
                ],
                color: '#2ecc71',
                info: {
                    title: 'Soullajule',
                    description: 'Historic Mexican land grant in western Marin County, known for its rugged coastal terrain.',
                    details: 'Granted to Manuel Cabello Torrejon in 1846, this rancho covered the coastal hills and valleys of western Marin. The name is derived from the Coast Miwok word for the area.',
                    features: 'Encompasses parts of present-day Lucas Valley and coastal hills. Now includes the Soullajule Reservoir and surrounding parklands.',
                    stats: {
                        'Grant Year': '1846',
                        'Original Grantee': 'Manuel Cabello Torrejon',
                        'Approximate Acres': '17,700',
                        'Notable Features': 'Soullajule Reservoir'
                    }
                }
            },
            'Laguna de San Antonio': {
                coordinates: [
                    [38.266165545687045, -122.80325317697137],
                    [38.2607742017911, -122.81835937814323],
                    [38.157992709215904, -122.76171112374871],
                    [38.18444380750062, -122.6734771759948],
                    [38.186062950631374, -122.67553711251824],
                    [38.191729668183555, -122.67279053048699],
                    [38.190650327400974, -122.6786270173034],
                    [38.194158126461524, -122.68103027658073],
                    [38.197395944866685, -122.68652344064323],
                    [38.19766575656877, -122.6902999909362],
                    [38.197395944866685, -122.69750976876824],
                    [38.20063361930768, -122.69956970529168],
                    [38.20063361930768, -122.70300293283073],
                    [38.19793556727113, -122.70574951486198],
                    [38.20360136107342, -122.71124267892448],
                    [38.20845740483092, -122.71295929269402],
                    [38.20953648167321, -122.71536255197137],
                    [38.2157408630576, -122.71398926095574],
                    [38.266165545687045, -122.80325317697137]
                ],
                color: '#9b59b6',
                info: {
                    title: 'Laguna de San Antonio',
                    description: 'Northernmost Mexican land grant in Marin County, extending into Sonoma County.',
                    details: 'Granted to Rafael Cacho in 1845, this rancho was named after a lagoon (now drained) that existed in the area. It represents the northern boundary of Mexican land grants in Marin.',
                    features: 'Covers parts of modern Petaluma and rural northern Marin. Known for its rolling hills and agricultural use.',
                    stats: {
                        'Grant Year': '1845',
                        'Original Grantee': 'Rafael Cacho',
                        'Approximate Acres': '17,200',
                        'Counties': 'Marin, Sonoma'
                    }
                }
            },
            'Buacocha': {
                coordinates: [
                    [38.188059842616006,-122.65768432931512],
                    [38.189948745667955,-122.65940094308463],
                    [38.189948745667955,-122.66489410714713],
                    [38.19183759973514,-122.66935730294792],
                    [38.19156776643893,-122.6731338532409],
                    [38.186440743869994,-122.67450714425652],
                    [38.18428188956117,-122.67244720773309],
                    [38.16538918547039,-122.73355865792838],
                    [38.16916811810983,-122.69476318673699],
                    [38.15081146744334,-122.67382049874871],
                    [38.151891398348354,-122.66558075265495],
                    [38.188059842616006,-122.65768432931512]
                ],
                color: '#1abc9c',
                info: {
                    title: 'Rancho de Buacocha',
                    description: 'Small but significant Mexican land grant in central Marin County.',
                    details: 'Granted to John Thomas Reed in 1834, this was one of the first Mexican land grants in Marin County. The name comes from the Coast Miwok village that once existed here.',
                    features: 'Located near present-day Mill Valley and Corte Madera. Known for its redwood groves and creek systems.',
                    stats: {
                        'Grant Year': '1834',
                        'Original Grantee': 'John Thomas Reed',
                        'Approximate Acres': '8,800',
                        'Significance': 'First land grant in Marin'
                    }
                }
            },
            'Olompali': {
                coordinates: [
                    [38.18730427097376,-122.6569976838073],
                    [38.18730427097376,-122.65184784249871],
                    [38.18541529934465,-122.64704132394401],
                    [38.18082759288977,-122.64257812814323],
                    [38.18136733805533,-122.63124847726434],
                    [38.17839869016438,-122.63090515451043],
                    [38.17839869016438,-122.62369537667838],
                    [38.182716683475874,-122.6188888581237],
                    [38.182986549561086,-122.60858917550652],
                    [38.180557718807606,-122.60687256173699],
                    [38.18001796764441,-122.59657287911979],
                    [38.18730427097376,-122.59210968331902],
                    [38.18838366134068,-122.5855865509948],
                    [38.184605725080246,-122.58524322824088],
                    [38.184335864992796,-122.5807800324401],
                    [38.1819070792224,-122.57563019113151],
                    [38.18082759288977,-122.57151031808465],
                    [38.17677937669912,-122.5687637360534],
                    [38.17704926477563,-122.56498718576043],
                    [38.17462023610256,-122.56498718576043],
                    [38.173810541886084,-122.56739044503777],
                    [38.164633378729604,-122.56773376779168],
                    [38.16544317489673,-122.56258392648307],
                    [38.1624738783073,-122.56155395822135],
                    [38.15923450773959,-122.56670379952996],
                    [38.15869459865288,-122.5584640534362],
                    [38.15329528791563,-122.55640411691276],
                    [38.149515532546694,-122.55709076242057],
                    [38.146815587361345,-122.55949402169792],
                    [38.14411554224382,-122.55743408517448],
                    [38.141145377195535,-122.55743408517448],
                    [38.138715152221245,-122.55777740792838],
                    [38.134394552417376,-122.55537414865104],
                    [38.13223415659008,-122.55915069894401],
                    [38.128993442945735,-122.55709076242057],
                    [38.12494234855876,-122.56052398995963],
                    [38.14276548221118,-122.58386993722526],
                    [38.14438555125244,-122.58970642404168],
                    [38.14762558140994,-122.59348297433465],
                    [38.14546557729398,-122.60103607492057],
                    [38.149245542525186,-122.60790252999871],
                    [38.1516754167422,-122.61408233956902],
                    [38.1516754167422,-122.61991882638542],
                    [38.14843556646459,-122.62163544015495],
                    [38.149515532546694,-122.62712860421745],
                    [38.14627558633235,-122.63330841378777],
                    [38.15059548263928,-122.64154815988151],
                    [38.14789557742748,-122.65390777902215],
                    [38.15194539776953,-122.66489410714713],
                    [38.18730427097376,-122.6569976838073]
                ],
                color: '#f39c12',
                info: {
                    title: 'Rancho Olompali',
                    description: 'Historic Mexican land grant with significant indigenous and Mexican-era history.',
                    details: 'Granted to Camilo Ynitia in 1843, this rancho is unique as Ynitia was a Coast Miwok leader. The site includes important archaeological remains and was later famous as a hippie commune in the 1960s.',
                    features: 'Now Olompali State Historic Park. Contains archaeological evidence of 6,000 years of human habitation, including Coast Miwok village sites.',
                    stats: {
                        'Grant Year': '1843',
                        'Original Grantee': 'Camilo Ynitia (Coast Miwok)',
                        'Approximate Acres': '8,900',
                        'Current Status': 'State Historic Park'
                    }
                }
            }
        };

        function initMap() {
            // Initialize map centered on Marin County
            map = L.map('map').setView([38.0834, -122.7633], 10);

            // Add OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Create region polygons with enhanced functionality
            Object.keys(regionData).forEach(regionName => {
                const region = regionData[regionName];
                
                // Create polygon with improved styling
                const polygon = L.polygon(region.coordinates, {
                    color: region.color,
                    weight: 3,
                    opacity: 0.8,
                    fillColor: region.color,
                    fillOpacity: 0.2,
                    smoothFactor: 1
                }).addTo(map);

                // Store region data
                regions.push({
                    name: regionName,
                    polygon: polygon,
                    data: region
                });

                // Enhanced click listener
                polygon.on('click', (e) => {
                    clearHighlight();
                    highlightRegion(polygon, region.color);
                    showRegionInfo(regionName, region.info);
                    
                    // Center map on polygon
                    const bounds = polygon.getBounds();
                    map.fitBounds(bounds, { padding: [20, 20] });
                });

                // Enhanced hover effects
                polygon.on('mouseover', function() {
                    if (highlightedRegion !== polygon) {
                        polygon.setStyle({
                            weight: 4,
                            opacity: 1,
                            fillOpacity: 0.3
                        });
                    }
                });

                polygon.on('mouseout', function() {
                    if (highlightedRegion !== polygon) {
                        polygon.setStyle({
                            weight: 3,
                            opacity: 0.8,
                            fillOpacity: 0.2
                        });
                    }
                });

                // Improved tooltip
                polygon.bindTooltip(`<strong>${regionName}</strong><br>Click for details`, {
                    permanent: false,
                    direction: 'center',
                    className: 'custom-tooltip'
                });
            });

            // Search functionality
            document.getElementById('searchBtn').addEventListener('click', searchAddress);
            document.getElementById('addressInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchAddress();
                }
            });
        }

        async function searchAddress() {
            const address = document.getElementById('addressInput').value.trim();
            if (!address) {
                showError('Please enter an address to search.');
                return;
            }

            showLoading();
            clearHighlight();

            try {
                // Enhanced Nominatim query with better parameters
                const query = encodeURIComponent(address + ', Marin County, California');
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=5&countrycodes=us&addressdetails=1`
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();

                if (data && data.length > 0) {
                    // Find the best match (preferring results in Marin County)
                    let bestResult = data.find(result => 
                        result.display_name.toLowerCase().includes('marin') ||
                        result.display_name.toLowerCase().includes('california')
                    ) || data[0];

                    const lat = parseFloat(bestResult.lat);
                    const lng = parseFloat(bestResult.lon);
                    const displayName = bestResult.display_name;

                    // Validate coordinates are reasonable for Marin County area
                    if (lat < 37.8 || lat > 38.3 || lng < -123.1 || lng > -122.4) {
                        showError('The address appears to be outside the Marin County area. Please try a different address.');
                        return;
                    }

                    // Clear previous marker
                    if (currentMarker) {
                        map.removeLayer(currentMarker);
                    }

                    // Add enhanced marker
                    currentMarker = L.marker([lat, lng], {
                        title: displayName
                    })
                        .addTo(map)
                        .bindPopup(`<strong>Found Location:</strong><br>${displayName}`)
                        .openPopup();

                    // Center map on result with appropriate zoom
                    map.setView([lat, lng], 15);

                    // Enhanced region detection
                    const foundRegion = findRegionContainingPoint(lat, lng);
                    
                    if (foundRegion) {
                        // Highlight the found region
                        highlightRegion(foundRegion.polygon, foundRegion.data.color);
                        
                        // Show region information with search context
                        showRegionInfo(foundRegion.name, foundRegion.data.info, {
                            address: displayName,
                            coordinates: [lat, lng]
                        });
                        
                        // Fit map to show both marker and region
                        const group = new L.featureGroup([currentMarker, foundRegion.polygon]);
                        map.fitBounds(group.getBounds(), { padding: [20, 20] });
                        
                    } else {
                        showNoRegionFound(displayName, lat, lng);
                    }
                } else {
                    showError('Address not found. Please try a more specific address or check the spelling.');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                showError('Search failed due to a network error. Please check your internet connection and try again.');
            }
        }

        // Enhanced point-in-polygon algorithm with better precision
        function findRegionContainingPoint(lat, lng) {
            for (let region of regions) {
                if (isPointInPolygon(lat, lng, region.data.coordinates)) {
                    return region;
                }
            }
            return null;
        }

        // Improved point-in-polygon algorithm (ray casting)
        function isPointInPolygon(lat, lng, coordinates) {
            let inside = false;
            const x = lat;
            const y = lng;
            
            for (let i = 0, j = coordinates.length - 1; i < coordinates.length; j = i++) {
                const xi = coordinates[i][0];
                const yi = coordinates[i][1];
                const xj = coordinates[j][0];
                const yj = coordinates[j][1];

                if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            return inside;
        }

        // Enhanced region highlighting
        function highlightRegion(polygon, color) {
            clearHighlight();
            polygon.setStyle({
                weight: 5,
                opacity: 1,
                fillOpacity: 0.4,
                color: color
            });
            highlightedRegion = polygon;
        }

        function clearHighlight() {
            if (highlightedRegion) {
                const regionData = regions.find(r => r.polygon === highlightedRegion);
                if (regionData) {
                    highlightedRegion.setStyle({
                        weight: 3,
                        opacity: 0.8,
                        fillOpacity: 0.2,
                        color: regionData.data.color
                    });
                }
                highlightedRegion = null;
            }
        }

        // Enhanced region information display
        function showRegionInfo(regionName, info, searchContext = null) {
            const infoContent = document.getElementById('infoContent');
            
            let searchContextHTML = '';
            if (searchContext) {
                searchContextHTML = `
                    <div class="coordinates-info">
                        <strong>📍 Search Result:</strong><br>
                        ${searchContext.address}<br>
                        <small>Coordinates: ${searchContext.coordinates[0].toFixed(6)}, ${searchContext.coordinates[1].toFixed(6)}</small>
                    </div>
                `;
            }
            
            infoContent.innerHTML = `
                <div class="info-title">${info.title}</div>
                ${searchContextHTML}
                <div class="info-text">${info.description}</div>
                <div class="info-text">${info.details}</div>
                <div class="region-stats">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">Historic Details</h3>
                    ${Object.keys(info.stats).map(stat => `
                        <div class="stat-item">
                            <span class="stat-label">${stat}:</span>
                            <span class="stat-value">${info.stats[stat]}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="info-text"><strong>Modern Features:</strong> ${info.features}</div>
            `;
        }

        function showLoading() {
            const infoContent = document.getElementById('infoContent');
            infoContent.innerHTML = '<div class="loading">Searching for address</div>';
        }

        function showError(message) {
            const infoContent = document.getElementById('infoContent');
            infoContent.innerHTML = `<div class="error"><strong>Error:</strong> ${message}</div>`;
        }

        function showNoRegionFound(address, lat, lng) {
            const infoContent = document.getElementById('infoContent');
            infoContent.innerHTML = `
                <div class="info-title">Location Found</div>
                <div class="coordinates-info">
                    <strong>📍 Address:</strong><br>${address}<br>
                    <small>Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}</small>
                </div>
                <div class="info-text">
                    This location is outside of the historic Mexican land grant boundaries shown on this map.
                </div>
                <div class="info-text">
                    The colored regions represent the original ranchos granted during the Mexican period (1821-1848). 
                    Your searched location may be in an area that was not part of these historic land grants.
                </div>
                <div class="search-suggestion">
                    <div class="suggestion-title">💡 Try these suggestions:</div>
                    • Search for addresses within the colored regions<br>
                    • Click directly on any colored region to learn about that rancho<br>
                    • Try searching for well-known locations like "San Rafael, CA" or "Novato, CA"
                </div>
            `;
        }

        // Add keyboard shortcuts and additional interactions
        document.addEventListener('keydown', function(e) {
            // Press 'Escape' to clear highlights and reset view
            if (e.key === 'Escape') {
                clearHighlight();
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                    currentMarker = null;
                }
                // Reset to default view
                map.setView([38.0834, -122.7633], 10);
                
                // Reset info panel to welcome message
                const infoContent = document.getElementById('infoContent');
                infoContent.innerHTML = `
                    <div class="info-title">Welcome to Regional Explorer</div>
                    <div class="info-text">
                        Enter any address in Marin County into the search box above to discover which historic rancho it belongs to.
                    </div>
                    <div class="info-text">
                        The map shows the original ranchos of Marin County with detailed information about each one.
                    </div>
                    <div class="info-text">
                        Click on any rancho polygon or search for an address to get detailed information!
                    </div>
                    <div class="info-text">
                        This system uses free OpenStreetMap data integrated using Leaflet.
                    </div>
                `;
            }
        });

        // Improve search input with suggestions
        document.getElementById('addressInput').addEventListener('input', function(e) {
            const value = e.target.value.toLowerCase();
            if (value.length > 2) {
                // Simple validation and suggestions could be added here
                // For now, we'll just ensure the input is clean
                this.value = this.value.replace(/[<>]/g, ''); // Basic XSS prevention
            }
        });

        // Add double-click to zoom functionality
        regions.forEach(region => {
            region.polygon.on('dblclick', function(e) {
                L.DomEvent.stopPropagation(e);
                map.fitBounds(region.polygon.getBounds(), { 
                    padding: [50, 50],
                    maxZoom: 14
                });
            });
        });

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', initMap);

        // Add window resize handler to maintain map responsiveness
        window.addEventListener('resize', function() {
            if (map) {
                setTimeout(function() {
                    map.invalidateSize();
                }, 100);
            }
        });
    </script>
</body>
</html>
